#include "DataWriter.h"

//--------------------------------------------------------------
DataWriter::DataWriter(){
    
    filePrefix = "default";
    filePostfix = "NA";
    fileExt = ".bin";
    fileCount = -1;
    bytesWritten = 0;
    dataRate = 0.0;
}

//--------------------------------------------------------------
DataWriter::DataWriter(string pfx, string pstfx, string ext){

    filePrefix = pfx;
    filePostfix = pstfx;
    fileExt = ext;
    fileCount = -1;
    bytesWritten = 0;
    dataRate = 0.0;
}

DataWriter::~DataWriter(){
}

//--------------------------------------------------------------
bool DataWriter::start(int elapsedTime){
    return nextFile(elapsedTime); // This creates the first filename and opens.
}   

//--------------------------------------------------------------
bool DataWriter::stop(){
    file.close();    
    return file.bad();
}

//--------------------------------------------------------------
bool DataWriter::writeData(char * data, unsigned int size){
               
    file.write(data,size); 
    bytesWritten += size;
    return file.bad(); 
}

//--------------------------------------------------------------
bool DataWriter::nextFile(int elapsedTime){

    // Close currently open file unless none have been opened yet.
    if (fileCount >= 0){
        file.close();
        ofSleepMillis(100);
        if (file.bad()){
            cout << "ERROR Closing File" << endl;
            return false;
            
        }
    }

    // Create new file name and open
    if (buildFileName(elapsedTime)){
        file.open(filename.c_str(), ios::out | ios::binary);
        if (file.bad()){
            cout << "ERROR Opening File" << endl;
            return false;
        } else {
            return true;
        }
    } else {
        return false;
    }
    
    // If made it here, there was an error
    return false;
}

//--------------------------------------------------------------
bool DataWriter::buildFileName(int elapsedTime){

    char tmpFileName[255]; // This should work on FAT32 and ext file systems
    string format;
    unsigned int length;

    fileCount++; // Make sure we don't use the same counter.

    // Use string methods to check string length, then create with sprintf and assign to filename string.
    length = filePrefix.length()+filePostfix.length()+fileExt.length()+TIMESTAMP_LENGTH+FILECOUNT_LENGTH+3;
    if (length < 255){
        format = filePrefix + "-"
            + ofGetTimestampString()
            + "-%0" + ofToString(FILECOUNT_LENGTH)+ "d-"
            + filePostfix+ "." + fileExt;
        int success = sprintf(tmpFileName,format.c_str(),fileCount);
        if (success > 0){
            filename.assign(tmpFileName);
            cout << filename << endl;
        } else {
            return false;
        }
    } else {
        return false;
    }
}
