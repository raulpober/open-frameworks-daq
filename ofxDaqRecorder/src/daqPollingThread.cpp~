#include "daqPollingThread.h"

daqPollingThread::daqPollingThread(libusb_device_handle* dev_handle, 
            unsigned char endpoint_in, 
            unsigned int sampleRate,
            unsigned int timeout,
            unsigned int bulkTxLength,
            dataBuffer* buffer)
{

    this->dev_handle = dev_handle;
    this->endpoint_in = endpoint_in;
    this->sampleRate = sampleRate;
    this->timeout = timeout;
    this->bulkTxLength = bulkTxLength;
    this->buffer = buffer;
}

void daqPollingThread::threadedFunction()
{
    int err = 0, transferred = 0;
    device->buffer->currIndex = 0;

    unsigned char* dataAsByte = (unsigned char*)daq->buffer->data;
    unsigned int timeout = 4;

    while (isThreadRunning()){
        err =  libusb_bulk_transfer(daq->device->dev_handle, daq->device->endpoint_in, &dataAsByte[device->buffer->currIndex*2], device->usbBulkTransferLength, &transferred, device->timeout);
        daq->buffer->currIndex += (transferred/2);
        daq->buffer->currCount += (transferred/2);
        if(err == LIBUSB_ERROR_TIMEOUT && transferred > 0)//a timeout may indicate that some data was transferred, but not all
            err = 0;
        if (err < 0)
            throw libUSBError(err);
        if(daq->buffer->currIndex >= (daq->buffer->getNumPoints()))
        {
            daq->buffer->currIndex = 0;
        }
    }
}
